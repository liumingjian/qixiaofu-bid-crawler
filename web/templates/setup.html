<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统初始化 - 图腾数安招标汇总</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/design-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <style>
        body {
            background-color: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: var(--spacing-4);
        }
        .setup-container {
            width: 100%;
            max-width: 500px;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            animation: slideUp 0.5s ease-out;
        }
        .setup-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e3a8a 100%);
            color: white;
            padding: 40px var(--spacing-6);
            text-align: center;
        }
        .setup-header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: var(--spacing-2);
        }
        .setup-header p {
            opacity: 0.9;
            font-size: 14px;
        }
        .setup-body {
            padding: var(--spacing-8);
        }
        .step-indicators {
            display: flex;
            justify-content: center;
            margin-bottom: var(--spacing-8);
        }
        .step-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border-color);
            margin: 0 6px;
            transition: all 0.3s ease;
        }
        .step-indicator.active {
            background: var(--primary-color);
            transform: scale(1.2);
        }
        .step-indicator.completed {
            background: var(--success-color);
        }
        
        /* Form Sections */
        .step-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .step-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: var(--spacing-4);
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .status-alert {
            padding: 12px;
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-4);
            font-size: 13px;
            display: none;
            animation: shake 0.3s ease-in-out;
        }
        .status-error {
            background-color: #fef2f2;
            color: var(--danger-color);
            border: 1px solid #fee2e2;
        }
        .status-success {
            background-color: #ecfdf5;
            color: var(--success-color);
            border: 1px solid #d1fae5;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="setup-header">
            <div style="margin-bottom: 16px;">
                <i class="bi bi-rocket-takeoff-fill" style="font-size: 40px;"></i>
            </div>
            <h1 id="headerTitle">系统初始化</h1>
            <p id="headerDesc">配置数据库连接以启动系统</p>
        </div>
        
        <div class="setup-body">
            <div class="step-indicators">
                <div class="step-indicator active" id="step1Dot"></div>
                <div class="step-indicator" id="step2Dot"></div>
            </div>

            <div id="statusAlert" class="status-alert"></div>

            <!-- Step 1: Database Config -->
            <div id="step1" class="step-section active">
                <form id="dbForm" onsubmit="return false;">
                    <div class="form-group">
                        <label class="form-label">数据库主机 (Host)</label>
                        <div style="position: relative;">
                            <input type="text" id="dbHost" value="{{ db_config.get('host', 'localhost') }}" placeholder="例如: localhost" style="padding-left: 36px;">
                            <i class="bi bi-hdd-network" style="position: absolute; left: 12px; top: 12px; color: var(--text-tertiary);"></i>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4);">
                        <div class="form-group">
                            <label class="form-label">端口 (Port)</label>
                            <input type="number" id="dbPort" value="{{ db_config.get('port', 5432) }}" placeholder="5432">
                        </div>
                        <div class="form-group">
                            <label class="form-label">数据库名 (DB Name)</label>
                            <input type="text" id="dbName" value="{{ db_config.get('name', 'qixiaofu_crawler') }}" placeholder="qixiaofu_crawler">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">用户名 (User)</label>
                        <div style="position: relative;">
                            <input type="text" id="dbUser" value="{{ db_config.get('user', 'postgres') }}" placeholder="postgres" style="padding-left: 36px;">
                            <i class="bi bi-person" style="position: absolute; left: 12px; top: 12px; color: var(--text-tertiary);"></i>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">密码 (Password)</label>
                        <div style="position: relative;">
                            <input type="password" id="dbPassword" value="{{ db_config.get('password', '') }}" placeholder="数据库密码" style="padding-left: 36px;">
                            <i class="bi bi-key" style="position: absolute; left: 12px; top: 12px; color: var(--text-tertiary);"></i>
                        </div>
                    </div>

                    <div style="margin-top: var(--spacing-8); display: flex; gap: var(--spacing-4);">
                        <button type="button" class="btn-secondary" style="flex: 1;" onclick="testConnection()" id="testBtn">
                            测试连接
                        </button>
                        <button type="button" class="btn-primary" style="flex: 1;" onclick="goToStep2()" id="nextBtn" disabled>
                            下一步 <i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 2: Admin Account -->
            <div id="step2" class="step-section">
                <form id="adminForm" onsubmit="return false;">
                    <div class="form-group">
                        <label class="form-label">管理员用户名</label>
                        <div style="position: relative;">
                            <input type="text" id="adminUser" value="admin" placeholder="admin" style="padding-left: 36px;">
                            <i class="bi bi-person-badge" style="position: absolute; left: 12px; top: 12px; color: var(--text-tertiary);"></i>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">设置密码</label>
                        <div style="position: relative;">
                            <input type="password" id="adminPass" placeholder="设置登录密码" style="padding-left: 36px;">
                            <i class="bi bi-lock" style="position: absolute; left: 12px; top: 12px; color: var(--text-tertiary);"></i>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">确认密码</label>
                        <div style="position: relative;">
                            <input type="password" id="adminPassConfirm" placeholder="再次输入密码" style="padding-left: 36px;">
                            <i class="bi bi-check2-circle" style="position: absolute; left: 12px; top: 12px; color: var(--text-tertiary);"></i>
                        </div>
                    </div>

                    <div style="margin-top: var(--spacing-8); display: flex; gap: var(--spacing-4);">
                        <button type="button" class="btn-secondary" onclick="goToStep1()">
                            <i class="bi bi-arrow-left me-2"></i> 上一步
                        </button>
                        <button type="button" class="btn-primary" style="flex: 1;" onclick="finishSetup()" id="finishBtn">
                            完成设置并启动
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let isDbVerified = false;

        async function testConnection() {
            const btn = document.getElementById('testBtn');
            const nextBtn = document.getElementById('nextBtn');
            const alert = document.getElementById('statusAlert');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner" style="width: 14px; height: 14px; border-width: 2px;"></span> 测试中...';
            alert.style.display = 'none';

            const config = getDbConfig();

            try {
                const response = await fetch('/api/setup/test-db', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                const data = await response.json();

                if (data.success) {
                    showAlert('连接成功！请继续设置管理员账号。', 'success');
                    isDbVerified = true;
                    nextBtn.disabled = false;
                } else {
                    showAlert('连接失败: ' + data.message, 'error');
                    isDbVerified = false;
                    nextBtn.disabled = true;
                }
            } catch (err) {
                showAlert('请求失败: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = '测试连接';
            }
        }

        function goToStep2() {
            if (!isDbVerified) return;
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            document.getElementById('step1Dot').classList.remove('active');
            document.getElementById('step1Dot').classList.add('completed');
            document.getElementById('step2Dot').classList.add('active');
            
            document.getElementById('headerTitle').textContent = '管理员设置';
            document.getElementById('headerDesc').textContent = '创建系统管理员账号';
            document.getElementById('statusAlert').style.display = 'none';
        }

        function goToStep1() {
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2Dot').classList.remove('active');
            document.getElementById('step1Dot').classList.remove('completed');
            document.getElementById('step1Dot').classList.add('active');

            document.getElementById('headerTitle').textContent = '系统初始化';
            document.getElementById('headerDesc').textContent = '配置数据库连接以启动系统';
        }

        async function finishSetup() {
            const user = document.getElementById('adminUser').value.trim();
            const pass = document.getElementById('adminPass').value;
            const confirm = document.getElementById('adminPassConfirm').value;

            if (!user || !pass) {
                showAlert('请输入用户名和密码', 'error');
                return;
            }
            if (pass !== confirm) {
                showAlert('两次输入的密码不一致', 'error');
                return;
            }

            const btn = document.getElementById('finishBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner" style="width: 14px; height: 14px; border-width: 2px;"></span> 启动中...';

            const payload = {
                database: getDbConfig(),
                admin: { username: user, password: pass }
            };

            try {
                const response = await fetch('/api/setup/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (data.success) {
                    // Redirect to login or dashboard
                    window.location.href = '/login'; 
                } else {
                    showAlert('保存失败: ' + data.message, 'error');
                    btn.disabled = false;
                    btn.textContent = '完成设置并启动';
                }
            } catch (err) {
                showAlert('请求失败: ' + err.message, 'error');
                btn.disabled = false;
                btn.textContent = '完成设置并启动';
            }
        }

        function getDbConfig() {
            return {
                host: document.getElementById('dbHost').value.trim(),
                port: parseInt(document.getElementById('dbPort').value) || 5432,
                name: document.getElementById('dbName').value.trim(),
                user: document.getElementById('dbUser').value.trim(),
                password: document.getElementById('dbPassword').value
            };
        }

        function showAlert(msg, type) {
            const alert = document.getElementById('statusAlert');
            alert.textContent = msg;
            alert.className = 'status-alert ' + (type === 'error' ? 'status-error' : 'status-success');
            alert.style.display = 'block';
        }

        // Reset verification on DB input change
        document.querySelectorAll('#step1 input').forEach(input => {
            input.addEventListener('input', () => {
                isDbVerified = false;
                document.getElementById('nextBtn').disabled = true;
                document.getElementById('statusAlert').style.display = 'none';
            });
        });
    </script>
</body>
</html>